# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- none

resources:
  repositories:
  - repository: cinchykubernetes
    type: git
    name: DevOps/cinchy.kubernetes
    ref: development

parameters:
- name: protocol
  type: string
  default: https
  values:
  - http
  - https
- name: domain
  type: string
  default: sandbox.cinchy.net
- name: basepath
  type: string
  default: basepath

steps:
- checkout: self
- checkout: cinchykubernetes
- script: dir $(Build.SourcesDirectory)
  displayName: Dir Build Sources Directory
- task: PowerShell@2
  displayName: Create Kubernetes Files
  inputs:
    targetType: 'inline'
    script: |
      $cluster_config_directory = "$(Build.SourcesDirectory)/cinchy.kubernetes/environment_kustomizations/cinchy_nonprod",
      $protocol = "${{ parameters.protocol }}",
      $domain = "${{ parameters.domain }}",
      $basepath = "${{ parameters.basepath }}"
      $encodedUrl = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes("${protocol}://${domain}/${basepath}/web"))

      #Clone Development Folder to new instance name
      Copy-Item -Path "$($env:cluster_config_directory)/development" -Destination "$($env:cluster_config_directory)/$($env:basepath)" -Recurse
      Write-Output "Folder $($env:cluster_config_directory)/$($env:basepath) created"
      
      Write-Host "Using Department: $($env:cluster_config_directory)"

      #Replace all references to new values

      #==================================================================$basepath/base==================================================================
      $regex = '(development)'
      (Get-Content $cluster_config_directory/$basepath/base/kustomization.yaml) -replace $regex, ${basepath} | Set-Content $cluster_config_directory/$basepath/base/kustomization.yaml

      $regex = '(aHR0cHM6Ly9kZXZlbG9wbWVudC5jaW5jaHkubmV0L3dlYg==)'
      (Get-Content $cluster_config_directory/$basepath/base/kustomization.yaml) -replace $regex, ${encodedUrl} | Set-Content $cluster_config_directory/$basepath/base/kustomization.yaml

      #==================================================================$basepath/connections==================================================================
      $encodedConnectionsConfig = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes(@"
      {
          "authority": "${protocol}://${domain}/${basepath}/sso",
          "cinchyRootUrl": "${protocol}://${domain}/${basepath}/web",
          "clientId": "cinchy_connections_experience",
          "redirectUri": "${protocol}://${domain}/${basepath}/connections",
          "model": "Cinchy",
          "domain": "Cinchy",
          "useHttps": true,
          "server": "${domain}/${basepath}/web",
          "version": "1.0.0"
      }
      "@))

      $regex = '(development.cinchy.net)'
      (Get-Content $cluster_config_directory/$basepath/connections/kustomization.yaml) -replace $regex, ${domain} | Set-Content $cluster_config_directory/$basepath/connections/kustomization.yaml

      $regex = '(development)'
      (Get-Content $cluster_config_directory/$basepath/connections/kustomization.yaml) -replace $regex, ${basepath} | Set-Content $cluster_config_directory/$basepath/connections/kustomization.yaml

      $regex = '(ewogICJhdXRob3JpdHkiOiAiaHR0cHM6Ly9kZXZlbG9wbWVudC5jaW5jaHkubmV0L3NzbyIsCiAgImNpbmNoeVJvb3RVcmwiOiAiaHR0cHM6Ly9kZXZlbG9wbWVudC5jaW5jaHkubmV0L3dlYiIsCiAgImNsaWVudElkIjogImNpbmNoeV9jb25uZWN0aW9uc19leHBlcmllbmNlIiwKICAicmVkaXJlY3RVcmkiOiAiaHR0cHM6Ly9kZXZlbG9wbWVudC5jaW5jaHkubmV0L2Nvbm5lY3Rpb25zIiwKICAibW9kZWwiOiAiQ2luY2h5IiwKICAiZG9tYWluIjogIkNpbmNoeSIsCiAgInVzZUh0dHBzIjogdHJ1ZSwKICAic2VydmVyIjogImRldmVsb3BtZW50LmNpbmNoeS5uZXQvd2ViIiwKICAidmVyc2lvbiI6ICIxLjAuMCIKfQ==)'
      (Get-Content $cluster_config_directory/$basepath/connections/kustomization.yaml) -replace $regex, ${encodedConnectionsConfig} | Set-Content $cluster_config_directory/$basepath/connections/kustomization.yaml

      #==================================================================$basepath/event-listener==================================================================
      $regex = '(development.cinchy.net)'
      (Get-Content $cluster_config_directory/$basepath/event-listener/kustomization.yaml) -replace $regex, ${domain} | Set-Content $cluster_config_directory/$basepath/event-listener/kustomization.yaml

      $regex = '(development)'
      (Get-Content $cluster_config_directory/$basepath/event-listener/kustomization.yaml) -replace $regex, ${basepath} | Set-Content $cluster_config_directory/$basepath/event-listener/kustomization.yaml

      #==================================================================$basepath/idp==================================================================
      $encodedIdpAppSettings = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes(@"
      {
          "CINCHY__ENCRYPTION__KEY": "7EAEAFBE112F016A9821AB8766DBE7BA962E13A7FCFCF7E8C5E2C8A801690862",
          "ConfigSettings": {
            "AppSettings": {
              "CinchyUri": "${protocol}://${domain}/${basepath}/web",
              "CertificatePath": "/app/cinchyidentitysrv.pfx",
              "CertificatePassword": "",
              "SAMLClientEntityId": "",
              "SAMLIDPEntityId": "",
              "SAMLMetadataXmlPath": "",
              "SAMLSSOServiceURL": "",
              "SAMLEncryptedCertificatePath": "",
              "SAMLEncryptedCertificatePassword": "",
              "SAMLSignCertificatePath": "",
              "SAMLSignCertificatePassword": "",
              "AcsURLModule": "",
              "StsPublicOriginUri": "${protocol}://${domain}/${basepath}/sso",
              "MaxRequestHeadersTotalSize": 65536,
              "MaxRequestBufferSize": 65536,
              "MaxRequestBodySize": -1,
              "MachineKeyXml": "",
              "DpApiKeyRingPath": "",
              "TlsVersion": "",
              "CinchyAccessTokenLifetime": "0.00:30:00",
              "DataChangeCallbackTimeout": 7,
              "RefreshCacheTimeInMin": 10,
              "DefaultExpirationCacheTimeInMin": 360,
              "DBType": "PostgreSQL"
            },
            "ConnectionStrings": {
              "SqlServer": "",
              "Redis": "redis-redis-cluster.redis.svc.cluster.local:6379"
            },
            "ExternalIdentityClaimSection": {
              "FirstName": {
                "ExternalClaimName": ""
              },
              "LastName": {
                "ExternalClaimName": ""
              },
              "Email": {
                "ExternalClaimName": ""
              },
              "MemberOf": {
                "ExternalClaimName": ""
              }
            },
            "KafkaCommunicationSettings": {
              "UseKafka": true,
              "KafkaCacheTopic": "${basepath}_cdc_notification",
              "BootstrapServers": "kafka-cluster-kafka-bootstrap.kafka.svc.cluster.local:9092",
              "ClusterIpAddresses": "",
              "ClusterCommunicationProtocol": "http",
              "ClusterCommunicationBaseUrl": "{PROTOCOL}://{IPADDRESS}/CinchyV2"
            }
          },
          "Logging": {
            "LogLevel": {
              "Default": "Debug"
            }
          },
          "Serilog": {
            "MinimumLevel": {
              "Default": "Debug",
              "Override": {
                "Microsoft": "Warning",
                "Microsoft.Hosting.Lifetime": "Information"
              }
            },
            "WriteTo": [
              {
                "Name": "Console",
                "Args": {
                  "formatter": "Serilog.Formatting.Compact.CompactJsonFormatter, Serilog.Formatting.Compact"
                }
              }
            ]
          }
        }
      "@))

      $idpAddPaths = @"
      value: "/"
          - op: replace
            path: /spec/http/0/match/0/uri/prefix
            value: "/${basepath}/sso/"
          - op: replace
            path: /spec/http/0/match/1/uri/prefix
            value: "/${basepath}/sso"
      "@

      $regex = '(development.cinchy.net)'
      (Get-Content $cluster_config_directory/$basepath/idp/kustomization.yaml) -replace $regex, ${domain} | Set-Content $cluster_config_directory/$basepath/idp/kustomization.yaml

      $regex = '(development)'
      (Get-Content $cluster_config_directory/$basepath/idp/kustomization.yaml) -replace $regex, ${basepath} | Set-Content $cluster_config_directory/$basepath/idp/kustomization.yaml

      $regex = '(ewogICJDSU5DSFlfX0VOQ1JZUFRJT05fX0tFWSI6ICI3RUFFQUZCRTExMkYwMTZBOTgyMUFCODc2NkRCRTdCQTk2MkUxM0E3RkNGQ0Y3RThDNUUyQzhBODAxNjkwODYyIiwKICAiQ29uZmlnU2V0dGluZ3MiOiB7CiAgICAiQXBwU2V0dGluZ3MiOiB7CiAgICAgICJDaW5jaHlVcmkiOiAiaHR0cHM6Ly9kZXZlbG9wbWVudC5jaW5jaHkubmV0L3dlYiIsCiAgICAgICJDZXJ0aWZpY2F0ZVBhdGgiOiAiL2FwcC9jaW5jaHlpZGVudGl0eXNydi5wZngiLAogICAgICAiQ2VydGlmaWNhdGVQYXNzd29yZCI6ICIiLAogICAgICAiU0FNTENsaWVudEVudGl0eUlkIjogIiIsCiAgICAgICJTQU1MSURQRW50aXR5SWQiOiAiIiwKICAgICAgIlNBTUxNZXRhZGF0YVhtbFBhdGgiOiAiIiwKICAgICAgIlNBTUxTU09TZXJ2aWNlVVJMIjogIiIsCiAgICAgICJTQU1MRW5jcnlwdGVkQ2VydGlmaWNhdGVQYXRoIjogIiIsCiAgICAgICJTQU1MRW5jcnlwdGVkQ2VydGlmaWNhdGVQYXNzd29yZCI6ICIiLAogICAgICAiU0FNTFNpZ25DZXJ0aWZpY2F0ZVBhdGgiOiAiIiwKICAgICAgIlNBTUxTaWduQ2VydGlmaWNhdGVQYXNzd29yZCI6ICIiLAogICAgICAiQWNzVVJMTW9kdWxlIjogIiIsCiAgICAgICJTdHNQdWJsaWNPcmlnaW5VcmkiOiAiaHR0cHM6Ly9kZXZlbG9wbWVudC5jaW5jaHkubmV0L3NzbyIsCiAgICAgICJNYXhSZXF1ZXN0SGVhZGVyc1RvdGFsU2l6ZSI6IDY1NTM2LAogICAgICAiTWF4UmVxdWVzdEJ1ZmZlclNpemUiOiA2NTUzNiwKICAgICAgIk1heFJlcXVlc3RCb2R5U2l6ZSI6IC0xLAogICAgICAiTWFjaGluZUtleVhtbCI6ICIiLAogICAgICAiRHBBcGlLZXlSaW5nUGF0aCI6ICIiLAogICAgICAiVGxzVmVyc2lvbiI6ICIiLAogICAgICAiQ2luY2h5QWNjZXNzVG9rZW5MaWZldGltZSI6ICIwLjAwOjMwOjAwIiwKICAgICAgIkRhdGFDaGFuZ2VDYWxsYmFja1RpbWVvdXQiOiA3LAogICAgICAiUmVmcmVzaENhY2hlVGltZUluTWluIjogMTAsCiAgICAgICJEZWZhdWx0RXhwaXJhdGlvbkNhY2hlVGltZUluTWluIjogMzYwLAogICAgICAiREJUeXBlIjogIlBvc3RncmVTUUwiCiAgICB9LAogICAgIkNvbm5lY3Rpb25TdHJpbmdzIjogewogICAgICAiU3FsU2VydmVyIjogIiIsCiAgICAgICJSZWRpcyI6ICJyZWRpcy1yZWRpcy1jbHVzdGVyLnJlZGlzLnN2Yy5jbHVzdGVyLmxvY2FsOjYzNzkiCiAgICB9LAogICAgIkV4dGVybmFsSWRlbnRpdHlDbGFpbVNlY3Rpb24iOiB7CiAgICAgICJGaXJzdE5hbWUiOiB7CiAgICAgICAgIkV4dGVybmFsQ2xhaW1OYW1lIjogIiIKICAgICAgfSwKICAgICAgIkxhc3ROYW1lIjogewogICAgICAgICJFeHRlcm5hbENsYWltTmFtZSI6ICIiCiAgICAgIH0sCiAgICAgICJFbWFpbCI6IHsKICAgICAgICAiRXh0ZXJuYWxDbGFpbU5hbWUiOiAiIgogICAgICB9LAogICAgICAiTWVtYmVyT2YiOiB7CiAgICAgICAgIkV4dGVybmFsQ2xhaW1OYW1lIjogIiIKICAgICAgfQogICAgfSwKICAgICJLYWZrYUNvbW11bmljYXRpb25TZXR0aW5ncyI6IHsKICAgICAgIlVzZUthZmthIjogdHJ1ZSwKICAgICAgIkthZmthQ2FjaGVUb3BpYyI6ICJkZXZlbG9wbWVudF9jZGNfbm90aWZpY2F0aW9uIiwKICAgICAgIkJvb3RzdHJhcFNlcnZlcnMiOiAia2Fma2EtY2x1c3Rlci1rYWZrYS1ib290c3RyYXAua2Fma2Euc3ZjLmNsdXN0ZXIubG9jYWw6OTA5MiIsCiAgICAgICJDbHVzdGVySXBBZGRyZXNzZXMiOiAiIiwKICAgICAgIkNsdXN0ZXJDb21tdW5pY2F0aW9uUHJvdG9jb2wiOiAiaHR0cCIsCiAgICAgICJDbHVzdGVyQ29tbXVuaWNhdGlvbkJhc2VVcmwiOiAie1BST1RPQ09MfTovL3tJUEFERFJFU1N9L0NpbmNoeVYyIgogICAgfQogIH0sCiAgIkxvZ2dpbmciOiB7CiAgICAiTG9nTGV2ZWwiOiB7CiAgICAgICJEZWZhdWx0IjogIkRlYnVnIgogICAgfQogIH0sCiAgIlNlcmlsb2ciOiB7CiAgICAiTWluaW11bUxldmVsIjogewogICAgICAiRGVmYXVsdCI6ICJEZWJ1ZyIsCgkgICJPdmVycmlkZSI6IHsKCQkiTWljcm9zb2Z0IjogIldhcm5pbmciLAoJCSJNaWNyb3NvZnQuSG9zdGluZy5MaWZldGltZSI6ICJJbmZvcm1hdGlvbiIKCSAgfQogICAgfSwKICAgICJXcml0ZVRvIjogWwogICAgICB7CiAgICAgICAgIk5hbWUiOiAiQ29uc29sZSIsCiAgICAgICAgIkFyZ3MiOiB7CiAgICAgICAgICAiZm9ybWF0dGVyIjogIlNlcmlsb2cuRm9ybWF0dGluZy5Db21wYWN0LkNvbXBhY3RKc29uRm9ybWF0dGVyLCBTZXJpbG9nLkZvcm1hdHRpbmcuQ29tcGFjdCIKICAgICAgICB9CiAgICAgIH0KICAgIF0KICB9Cn0=)'
      (Get-Content $cluster_config_directory/$basepath/idp/kustomization.yaml) -replace $regex, ${encodedIdpAppSettings} | Set-Content $cluster_config_directory/$basepath/idp/kustomization.yaml

      $regex = '(value: "/")'
      (Get-Content $cluster_config_directory/$basepath/idp/kustomization.yaml) -replace $regex, ${idpAddPaths} | Set-Content $cluster_config_directory/$basepath/idp/kustomization.yaml

      #==================================================================$basepath/maintenance-cli==================================================================
      $regex = '(development.cinchy.net)'
      (Get-Content $cluster_config_directory/$basepath/maintenance-cli/kustomization.yaml) -replace $regex, ${domain} | Set-Content $cluster_config_directory/$basepath/maintenance-cli/kustomization.yaml

      $regex = '(development)'
      (Get-Content $cluster_config_directory/$basepath/maintenance-cli/kustomization.yaml) -replace $regex, ${basepath} | Set-Content $cluster_config_directory/$basepath/maintenance-cli/kustomization.yaml

      #==================================================================$basepath/meta-forms==================================================================
      $encodedFormsConfig = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes(@"
      {
          "authority": "${protocol}://${domain}/${basepath}/sso",
          "cinchyRootUrl": "${protocol}://${domain}/${basepath}/web",
          "clientId": "meta-forms",
          "redirectUri": "${protocol}://${domain}/${basepath}/forms",
          "version": "2.5.5"
      }
      "@))

      $regex = '(development.cinchy.net)'
      (Get-Content $cluster_config_directory/$basepath/meta-forms/kustomization.yaml) -replace $regex, ${domain} | Set-Content $cluster_config_directory/$basepath/meta-forms/kustomization.yaml

      $regex = '(development)'
      (Get-Content $cluster_config_directory/$basepath/meta-forms/kustomization.yaml) -replace $regex, ${basepath} | Set-Content $cluster_config_directory/$basepath/meta-forms/kustomization.yaml

      $regex = '(ewogICJhdXRob3JpdHkiOiAiaHR0cHM6Ly9kZXZlbG9wbWVudC5jaW5jaHkubmV0L3NzbyIsCiAgImNpbmNoeVJvb3RVcmwiOiAiaHR0cHM6Ly9kZXZlbG9wbWVudC5jaW5jaHkubmV0L3dlYiIsCiAgImNsaWVudElkIjogImRlYWxzLW92ZXJ2aWV3IiwKICAicmVkaXJlY3RVcmkiOiAiaHR0cHM6Ly9kZXZlbG9wbWVudC5jaW5jaHkubmV0L21ldGEtZm9ybXMiLAogICJ2ZXJzaW9uIjogIjIuNS41Igp9)'
      (Get-Content $cluster_config_directory/$basepath/meta-forms/kustomization.yaml) -replace $regex, ${encodedFormsConfig} | Set-Content $cluster_config_directory/$basepath/meta-forms/kustomization.yaml

      #==================================================================$basepath/postgres==================================================================
      $regex = '(development)'
      (Get-Content $cluster_config_directory/$basepath/postgres/kustomization.yaml) -replace $regex, ${basepath} | Set-Content $cluster_config_directory/$basepath/postgres/kustomization.yaml

      #==================================================================$basepath/web==================================================================
      $encodedWebAppSettings = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes(@"
      {
          "ConfigSettings": {
            "AppSettings": {
              "StsAuthorityUri": "${protocol}://${domain}/${basepath}/sso",
              "AllowLogFileDownload": false,
              "LogDirectoryPath": "",
              "SSOLogPath": "",
              "UseHttps": true,
              "HstsMaxAge": 2592000,
              "HstsIncludeSubDomains": false,
              "HstsPreload": false,
              "TlsVersion": "",
              "RouteDebuggerEnabled": false,
              "RefreshCacheTimeInMin": 10,
              "DefaultExpirationCacheTimeInMin": 360,
              "DBType": "PostgreSQL"
            },
            "ReverseProxySettings": {
              "IsEnabled": true,
              "BasePath": "/web",
              "UseHttps": true
            },
            "ConnectionStrings": {
              "SqlServer": "",
              "Redis": "redis-redis-cluster.redis.svc.cluster.local:6379"
            },
            "KafkaCommunicationSettings": {
              "UseKafka": true,
              "BootstrapServers": "kafka-cluster-kafka-bootstrap.kafka.svc.cluster.local:9092",
              "ClusterIpAddresses": "",
              "ClusterCommunicationProtocol": "http",
              "ClusterCommunicationBaseUrl": "{PROTOCOL}://{IPADDRESS}/Cinchy"
            }
          },
          "Logging": {
            "MinimumLevel": {
              "Default": "Debug",
              "Override": {
                "Microsoft": "Warning",
                "Microsoft.Hosting.Lifetime": "Information"
              }
            }
          },
          "Serilog": {
            "MinimumLevel": {
              "Default": "Debug",
              "Override": {
                "Microsoft": "Warning",
                "Microsoft.Hosting.Lifetime": "Information"
              }
            },
            "WriteTo": [
              {
                "Name": "Console",
                "Args": {
                  "formatter": "Serilog.Formatting.Compact.CompactJsonFormatter, Serilog.Formatting.Compact"
                }
              }
            ]
          },
          "AllowedHosts": "*"
      }  
      "@))

      $webAddPaths = @"
      value: "/"
          - op: replace
            path: /spec/http/0/match/0/uri/prefix
            value: "/${basepath}/web/"
          - op: replace
            path: /spec/http/0/match/1/uri/prefix
            value: "/${basepath}/web"
      "@

      $regex = '(development.cinchy.net)'
      (Get-Content $cluster_config_directory/$basepath/web/kustomization.yaml) -replace $regex, ${domain} | Set-Content $cluster_config_directory/$basepath/web/kustomization.yaml

      $regex = '(development)'
      (Get-Content $cluster_config_directory/$basepath/web/kustomization.yaml) -replace $regex, ${basepath} | Set-Content $cluster_config_directory/$basepath/web/kustomization.yaml

      $regex = '(ewogICJDb25maWdTZXR0aW5ncyI6IHsKICAgICJBcHBTZXR0aW5ncyI6IHsKICAgICAgIlN0c0F1dGhvcml0eVVyaSI6ICJodHRwczovL2RldmVsb3BtZW50LmNpbmNoeS5uZXQvc3NvIiwKICAgICAgIkFsbG93TG9nRmlsZURvd25sb2FkIjogZmFsc2UsCiAgICAgICJMb2dEaXJlY3RvcnlQYXRoIjogIiIsCiAgICAgICJTU09Mb2dQYXRoIjogIiIsCiAgICAgICJVc2VIdHRwcyI6IHRydWUsCiAgICAgICJIc3RzTWF4QWdlIjogMjU5MjAwMCwKICAgICAgIkhzdHNJbmNsdWRlU3ViRG9tYWlucyI6IGZhbHNlLAogICAgICAiSHN0c1ByZWxvYWQiOiBmYWxzZSwKICAgICAgIlRsc1ZlcnNpb24iOiAiIiwKICAgICAgIlJvdXRlRGVidWdnZXJFbmFibGVkIjogZmFsc2UsCiAgICAgICJSZWZyZXNoQ2FjaGVUaW1lSW5NaW4iOiAxMCwKICAgICAgIkRlZmF1bHRFeHBpcmF0aW9uQ2FjaGVUaW1lSW5NaW4iOiAzNjAsCiAgICAgICJEQlR5cGUiOiAiUG9zdGdyZVNRTCIKICAgIH0sCiAgICAiUmV2ZXJzZVByb3h5U2V0dGluZ3MiOiB7CiAgICAgICJJc0VuYWJsZWQiOiB0cnVlLAogICAgICAiQmFzZVBhdGgiOiAiL3dlYiIsCiAgICAgICJVc2VIdHRwcyI6IHRydWUKICAgIH0sCiAgICAiQ29ubmVjdGlvblN0cmluZ3MiOiB7CiAgICAgICJTcWxTZXJ2ZXIiOiAiIiwKICAgICAgIlJlZGlzIjogInJlZGlzLXJlZGlzLWNsdXN0ZXIucmVkaXMuc3ZjLmNsdXN0ZXIubG9jYWw6NjM3OSIKICAgIH0sCiAgICAiS2Fma2FDb21tdW5pY2F0aW9uU2V0dGluZ3MiOiB7CiAgICAgICJVc2VLYWZrYSI6IHRydWUsCiAgICAgICJCb290c3RyYXBTZXJ2ZXJzIjogImthZmthLWNsdXN0ZXIta2Fma2EtYm9vdHN0cmFwLmthZmthLnN2Yy5jbHVzdGVyLmxvY2FsOjkwOTIiLAogICAgICAiQ2x1c3RlcklwQWRkcmVzc2VzIjogIiIsCiAgICAgICJDbHVzdGVyQ29tbXVuaWNhdGlvblByb3RvY29sIjogImh0dHAiLAogICAgICAiQ2x1c3RlckNvbW11bmljYXRpb25CYXNlVXJsIjogIntQUk9UT0NPTH06Ly97SVBBRERSRVNTfS9DaW5jaHkiCiAgICB9CiAgfSwKICAiTG9nZ2luZyI6IHsKICAgICJNaW5pbXVtTGV2ZWwiOiB7CiAgICAgICJEZWZhdWx0IjogIkRlYnVnIiwKICAgICAgIk92ZXJyaWRlIjogewoJCSJNaWNyb3NvZnQiOiAiV2FybmluZyIsCgkJIk1pY3Jvc29mdC5Ib3N0aW5nLkxpZmV0aW1lIjogIkluZm9ybWF0aW9uIgoJICB9CiAgICB9CiAgfSwKICAiU2VyaWxvZyI6IHsKICAgICJNaW5pbXVtTGV2ZWwiOiB7CiAgICAgICJEZWZhdWx0IjogIkRlYnVnIiwKCSAgIk92ZXJyaWRlIjogewoJCSJNaWNyb3NvZnQiOiAiV2FybmluZyIsCgkJIk1pY3Jvc29mdC5Ib3N0aW5nLkxpZmV0aW1lIjogIkluZm9ybWF0aW9uIgoJICB9CiAgICB9LAogICAgIldyaXRlVG8iOiBbCiAgICAgIHsKICAgICAgICAiTmFtZSI6ICJDb25zb2xlIiwKICAgICAgICAiQXJncyI6IHsKICAgICAgICAgICJmb3JtYXR0ZXIiOiAiU2VyaWxvZy5Gb3JtYXR0aW5nLkNvbXBhY3QuQ29tcGFjdEpzb25Gb3JtYXR0ZXIsIFNlcmlsb2cuRm9ybWF0dGluZy5Db21wYWN0IgogICAgICAgIH0KICAgICAgfQogICAgXQogIH0sCiAgIkFsbG93ZWRIb3N0cyI6ICIqIgp9Cg==)'
      (Get-Content $cluster_config_directory/$basepath/web/kustomization.yaml) -replace $regex, ${encodedWebAppSettings} | Set-Content $cluster_config_directory/$basepath/web/kustomization.yaml

      $regex = '(value: "/")'
      (Get-Content $cluster_config_directory/$basepath/web/kustomization.yaml) -replace $regex, ${webAddPaths} | Set-Content $cluster_config_directory/$basepath/web/kustomization.yaml

      #==================================================================$basepath/worker==================================================================
      $regex = '(development.cinchy.net)'
      (Get-Content $cluster_config_directory/$basepath/worker/kustomization.yaml) -replace $regex, ${domain} | Set-Content $cluster_config_directory/$basepath/worker/kustomization.yaml

      $regex = '(development)'
      (Get-Content $cluster_config_directory/$basepath/worker/kustomization.yaml) -replace $regex, ${basepath} | Set-Content $cluster_config_directory/$basepath/worker/kustomization.yaml
- task: PowerShell@2
  displayName: Create ArgoCD Files
  inputs:
    targetType: 'inline'
    script: |
      $argocd_config_directory = "$(Build.SourcesDirectory)/cinchy.argocd/environment_kustomizations/cinchy_nonprod",
      $basepath = "${{ parameters.basepath }}"

      #Clone Development Folder to new instance name
      Copy-Item -Path "${argocd_config_directory}/development" -Destination "${argocd_config_directory}/${basepath}" -Recurse
      Write-Output "Folder ${argocd_config_directory}/${basepath} created"

      #Replace all references to new values

      #===============================================================================$basepath/patch.yaml===================================================================================================

      $regex = '(development)'
      (Get-Content $argocd_config_directory/$basepath/cinchy/patch.yaml) -replace $regex, ${basepath} | Set-Content $argocd_config_directory/$basepath/cinchy/patch.yaml

      #===============================================================================$basepath/platform_components/kustomization.yaml=======================================================================

      $regex = '(development)'
      (Get-Content $argocd_config_directory/$basepath/platform_components/kustomization.yaml) -replace $regex, ${basepath} | Set-Content $argocd_config_directory/$basepath/platform_components/kustomization.yaml

      #===============================================================================$basepath/platform_components/patch.yaml===============================================================================

      $regex = '(development)'
      (Get-Content $argocd_config_directory/$basepath/platform_components/patch.yaml) -replace $regex, ${basepath} | Set-Content $argocd_config_directory/$basepath/platform_components/patch.yaml

- script: dir $(Build.SourcesDirectory)/cinchy.kubernetes
  displayName: Dir cinchy.kubernetes
- script: dir $(Build.SourcesDirectory)/cinchy.argocd
  displayName: Dir cinchy.argocd